<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>The Bingo Machine</title>
</head>
<body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


    <div class="container">

        <div class="row">
            <div class="col s12">
                <nav class="orange darken-4"><span class="center-align"><h2>Bingo Machine</h2></span></nav>
            </div>
        </div>

        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div id="history"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col s6 offset-s3">
                <div class="card">
                    <div id="draw"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col s12">
                <div id="controls">
                    <span class="waves-effect waves-light btn-large orange darken-4" id="resetButton"><i class="material-icons left">cached</i>Reset</span>
                    <span class="dropdown-trigger btn-large orange darken-4" id="timingButton" data-target='timerDropdown'><i class="material-icons left">speed</i>Timing</span>
                    <span class="waves-effect waves-light btn-large orange darken-4 right" id="startStopButton"><i class='material-icons left'>play_circle_outline</i>Start</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Dropdown Structure -->
    <ul id='timerDropdown' class='dropdown-content'>
        <li><a href="#!"><i class="material-icons">looks_one</i>hare</a></li>
        <li><a href="#!"><i class="material-icons">looks_two</i>fast</a></li>
        <li><a href="#!"><i class="material-icons">looks_3</i>normal</a></li>
        <li><a href="#!"><i class="material-icons">looks_4</i>slow</a></li>
        <li><a href="#!"><i class="material-icons">looks_5</i>turtle</a></li>
    </ul>

    <script type="text/javascript">
        const domain = {
            "width": 3200,
            "height": 550,
            "fontSize": 100,
            "drawFontSize": 400
        }

        /**
        * Shuffles array in place.
        * @param {Array} a items An array containing the items.
        * (from https://stackoverflow.com/questions/6274339/how-can-i-shuffle-an-array)
        */
        function shuffle(a) {
            var j, x, i;
            for (i = a.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = a[i];
                a[i] = a[j];
                a[j] = x;
            }
            return a;
        }

        const histPane = d3.select("#history").append("svg")
            .attr("viewBox", [0, 0, domain.width, domain.height])
            .attr("font-family", "sans-serif")
            .attr("font-size", domain.fontSize)
            .style("display", "block");

        const drawPane = d3.select("#draw").append("svg")
            .attr("viewBox", [0, 0, domain.width / 2, domain.height])
            .attr("font-family", "sans-serif")
            .attr("font-size", domain.drawFontSize)
            .style("display", "block");

        const resetButton = d3.select("#resetButton");
        resetButton.on("click", reset);

        const startStopButton = d3.selectAll("#startStopButton");
        startStopButton.on("click", startStop);

        const timingButton = d3.select("#timingButton");
        document.addEventListener('DOMContentLoaded', function() {
            var elems = document.querySelectorAll('.dropdown-trigger');
            var instances = M.Dropdown.init(elems, {});
        });

        var draws = [];
        var currentDrawIndex = 0;
        var timer = null;

        function updateHistory(hist) {
            var content = histPane.selectAll("text").data(hist, (d,i) => i);

            content.enter().append("text")
                .attr("x", (d,i) => domain.fontSize * 2 * (1 + i % 15))
                .attr("y", (d,i) => domain.fontSize * Math.floor(1 + (i / 15)))
                .attr("text-anchor", "end")
                .attr("font-size", 0)
                .text((d,i) => d)
                .transition()
                .attr("font-size", domain.fontSize);

            content.text(d => d);
            content.exit().remove();
        }

        function updateDraw(draw) {
            var content;

            if (draw < 0) {
                content = drawPane.selectAll("text").data([], d => 1);
            } else {
                content = drawPane.selectAll("text").data([draw], d => 1);
            }

            content.enter().append("text")
                .attr("x", (d,i) => domain.drawFontSize * 2 * (1 + i % 15))
                .attr("y", (d,i) => domain.drawFontSize * Math.floor(1 + (i / 15)))
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .attr("fill-opacity", 0)
                .text((d,i) => d)
                .transition()
                .duration(300)
                .attr("fill-opacity", 1)
                .transition()
                .duration(5000)
                .delay(300)
                .attr("fill", "#e65100");

            content
                .transition()
                .duration(300)
                .attr("fill-opacity", 0)

                .transition()
                .duration(300)
                .delay(300)
                .text((d,i) => d)
                .attr("fill", "black")
                .attr("fill-opacity", 1)
                
                .transition()
                .duration(5000)
                .delay(600)
                .attr("fill", "#e65100");

            content.exit().remove();
        }

        function reset() {
            if (timer != null)
                startStop();

            draws = [];
            for (var i = 0; i < 75; i++) { draws.push(i+1); }
            shuffle(draws)
            currentDrawIndex = 0;

            updateHistory([]);
            updateDraw(-1);
        }

        function startStop() {
            if (timer != null) {
                clearInterval(timer);
                timer = null;
                startStopButton.html("<i class='material-icons left'>play_circle_outline</i>Start")
            } else {
                timer = setInterval(draw, 5000);
                startStopButton.html("<i class='material-icons left'>pause_circle_outline</i>Stop")
                draw();
            }
        }

        function draw() {
            console.log(`draw ${currentDrawIndex}`);
            updateHistory(draws.slice(0, currentDrawIndex));
            updateDraw(draws[currentDrawIndex]);
            currentDrawIndex += 1;
            if (currentDrawIndex > 75 && timer != null)
                startStop();
        }

        reset();
    </script>

</body>
</html>